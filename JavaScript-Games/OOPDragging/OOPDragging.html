<!doctype html>
<html>

<head>
    <script>
        //JavaScript HTML5 Canvas example by Dan Gries, rectangleworld.com.
         //The basic setup here, including the debugging code and window load listener, is copied from 'HTML5 Canvas' by Fulton & Fulton.
         //Checking for browser compatibility is accomplished with the Modernizr JavaScript library.
         //The latest version of the library is available at www.modernizr.com.

        window.addEventListener("load", canvasApp, false);

        function SquareTile(posX, posY) {
            this.x = posX;
            this.y = posY;
            this.velX = 0;
            this.velY = 0;
            this.accelX = 0;
            this.accelY = 0;
            this.color = "#FF0000";
            this.radius = 10;
        }

         //The function below returns a Boolean value representing whether the point with the coordinates supplied "hits" the particle.
        SquareTile.prototype.hitTest = function (hitX, hitY) {
            return ((hitX > this.x - this.radius) && (hitX < this.x + this.radius) && (hitY > this.y - this.radius) && (hitY < this.y + this.radius));
        };

         //A function for drawing the particle.
        SquareTile.prototype.drawToContext = function (theContext) {
            theContext.fillStyle = this.color;
            theContext.fillRect(this.x - this.radius, this.y - this.radius, 2 * this.radius, 2 * this.radius);
        };

        function canvasApp() {

            var canvas = document.createElement("canvas");
            canvas.width = canvas.height = 500;
            var context = canvas.getContext("2d");
            document.body.appendChild(canvas);

            init();

            var numShapes;
            var shapes;
            var dragIndex;
            var dragging;
            var mouseX;
            var mouseY;
            var dragHoldX;
            var dragHoldY;
            var timer;
            var targetX;
            var targetY;
            var easeAmount;

            function init() {
                numShapes = 25;
                easeAmount = 0.45;

                shapes = [];

                makeShapes();

                drawScreen();

                canvas.addEventListener("mousedown", mouseDownListener, false);
            }

            function makeShapes() {
                var i;
                var tempX;
                var tempY;
                var tempRad;
                var tempColor;
                var red = "rgb(247,153,141)";
                var blue = "rgb(120,200,245)";
                var radius = 40;

                for (i = 0; i < numShapes; i++) {
                    tempRad = radius;
                    tempX = Math.random() * (canvas.width - tempRad);
                    tempY = Math.random() * (canvas.height - tempRad);
                    tempColor = Math.random() < 0.5 ? red : blue;
                    tempShape = new SquareTile(tempX, tempY);
                    tempShape.color = tempColor;
                    tempShape.radius = tempRad;
                    shapes.push(tempShape);
                }
            }

            function mouseDownListener(evt) {
                var i;

                //getting mouse position correctly 
                var bRect = canvas.getBoundingClientRect();
                mouseX = (evt.clientX - bRect.left) * (canvas.width / bRect.width);
                mouseY = (evt.clientY - bRect.top) * (canvas.height / bRect.height);

                // Find if a shape was clicked. 
                for (i = 0; i < numShapes; i++) {
                    if (shapes[i].hitTest(mouseX, mouseY)) {
                        dragging = true;
                        //the following variable will be reset if this loop repeats with another successful hit:
                        dragIndex = i;
                    }
                }

                if (dragging) {
                    window.addEventListener("mousemove", mouseMoveListener, false);

                    //place currently dragged shape on top
                    shapes.push(shapes.splice(dragIndex, 1)[0]);

                    //shapeto drag is now last one in array
                    dragHoldX = mouseX - shapes[numShapes - 1].x;
                    dragHoldY = mouseY - shapes[numShapes - 1].y;

                    //The "target" position is where the object should be if it were to move there instantaneously. But we will
                    //set up the code so that this target position is approached gradually, producing a smooth motion.
                    targetX = mouseX - dragHoldX;
                    targetY = mouseY - dragHoldY;

                    //start timer
                    timer = setInterval(onTimerTick, 1000 / 30);
                }
                canvas.removeEventListener("mousedown", mouseDownListener, false);
                window.addEventListener("mouseup", mouseUpListener, false);

                //code below prevents the mouse down from having an effect on the main browser window:
                if (evt.preventDefault) {
                    evt.preventDefault();
                } //standard
                else if (evt.returnValue) {
                    evt.returnValue = false;
                } //older IE
                return false;
            }

            function onTimerTick() {
                //because of reordering, the dragging shape is the last one in the array.
                shapes[numShapes - 1].x = shapes[numShapes - 1].x + easeAmount * (targetX - shapes[numShapes - 1].x);
                shapes[numShapes - 1].y = shapes[numShapes - 1].y + easeAmount * (targetY - shapes[numShapes - 1].y);

                //stop the timer when the target position is reached (close enough)
                if ((!dragging) && (Math.abs(shapes[numShapes - 1].x - targetX) < 0.1) && (Math.abs(shapes[numShapes - 1].y - targetY) < 0.1)) {
                    shapes[numShapes - 1].x = targetX;
                    shapes[numShapes - 1].y = targetY;
                    //stop timer:
                    clearInterval(timer);
                }
                drawScreen();
            }

            function mouseUpListener(evt) {
                canvas.addEventListener("mousedown", mouseDownListener, false);
                window.removeEventListener("mouseup", mouseUpListener, false);
                if (dragging) {
                    dragging = false;
                    window.removeEventListener("mousemove", mouseMoveListener, false);
                }
            }

            function mouseMoveListener(evt) {
                var posX;
                var posY;
                var shapeRad = shapes[numShapes - 1].radius;
                var minX = shapeRad;
                var maxX = canvas.width - shapeRad;
                var minY = shapeRad;
                var maxY = canvas.height - shapeRad;

                //getting mouse position correctly 
                var bRect = canvas.getBoundingClientRect();
                mouseX = (evt.clientX - bRect.left) * (canvas.width / bRect.width);
                mouseY = (evt.clientY - bRect.top) * (canvas.height / bRect.height);

                //clamp x and y positions to prevent object from dragging outside of canvas
                posX = mouseX - dragHoldX;
                posX = (posX < minX) ? minX : ((posX > maxX) ? maxX : posX);
                posY = mouseY - dragHoldY;
                posY = (posY < minY) ? minY : ((posY > maxY) ? maxY : posY);

                targetX = posX;
                targetY = posY;
            }

            function drawShapes() {
                var i;
                for (i = 0; i < numShapes; i++) {
                    //the drawing of the shape is handled by a function inside the external class.
                    //we must pass as an argument the context to which we are drawing the shape.
                    shapes[i].drawToContext(context);
                }
            }

            function drawScreen() {
                //bg
                context.fillStyle = "#000000";
                context.fillRect(0, 0, canvas.width, canvas.height);

                drawShapes();
            }

        }
    </script>

</head>

<body>
</body>

</html>
